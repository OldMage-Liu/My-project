# 百度地图爬虫 - 内存优化说明

## 📊 内存优化概述

本项目已经实施了完整的内存管理和优化方案，确保长时间运行时内存得到有效控制和释放。

## ✅ 已实施的优化措施

### 1. **自动内存监控**
- ✅ 程序启动时显示初始内存使用
- ✅ 每10个地区自动清理和报告内存使用
- ✅ 任务完成前显示内存使用情况
- ✅ 程序结束时显示最终内存使用

### 2. **主动垃圾回收**
```python
import gc  # 垃圾回收模块
gc.collect()  # 强制触发Python垃圾回收
```

### 3. **批量数据处理**
- ✅ 数据批次大小：50条/批次
- ✅ 达到批次大小立即保存并清空缓存
- ✅ 避免大量数据积累在内存中

### 4. **临时变量清理**
```python
# 每个地区处理完成后
data_batch = []  # 清空数据批次
previous_page_names = []  # 清空页面缓存
```

### 5. **定期内存清理**
- 每处理10个地区触发一次内存清理
- 使用 `gc.collect()` 强制回收未使用对象

### 6. **资源管理**
- ✅ 使用 `with` 语句管理 Playwright 浏览器上下文
- ✅ 程序结束时正确关闭浏览器
- ✅ 文件操作使用 `with` 语句自动关闭

## 📈 内存使用监控

### 监控点
1. **启动时**: 🚀 程序启动 - 初始内存: XX.XX MB
2. **运行中**: 📊 当前内存使用: XX.XX MB (每10个地区)
3. **完成前**: 📊 任务完成前内存使用: XX.XX MB
4. **结束时**: ✅ 浏览器已关闭 - 最终内存: XX.XX MB

### 日志输出
所有内存操作都会记录在日志中：
- `logger.info(f"🧹 内存清理完成 - 当前使用: {get_memory_info()}")`

## 🛠️ 使用的工具

### psutil 库
```python
import psutil
current_process = psutil.Process()
mem_info = current_process.memory_info()
mem_mb = mem_info.rss / 1024 / 1024  # 转换为MB
```

### gc 模块
```python
import gc
gc.collect()  # 强制垃圾回收
```

## 💡 优化效果

### 优化前可能的问题
- ❌ 内存持续增长
- ❌ 长时间运行后可能OOM
- ❌ 大量临时变量未释放

### 优化后的改进
- ✅ 内存使用可控
- ✅ 定期自动清理
- ✅ 及时释放临时变量
- ✅ 批量处理避免内存堆积
- ✅ 实时监控内存状态

## 📝 运行示例

```
🚀 程序启动 - 初始内存: 85.23 MB
[INFO] 正在搜索: 广州市越秀区烟酒
✅ 批量存储成功 | 数量: 50 条 | ...
📊 当前内存使用: 92.15 MB
🧹 内存清理完成 - 当前使用: 88.47 MB
...
📊 任务完成前内存使用: 95.32 MB
🧹 内存清理完成 - 当前使用: 86.21 MB
✅ 浏览器已关闭 - 最终内存: 82.15 MB
```

## 🔧 自定义配置

### 调整批次大小
```python
# 在 baidu_spider.py 中修改
BATCH_SIZE = 50  # 可根据实际情况调整（建议: 30-100）
```

### 调整清理频率
```python
# 每10个地区清理一次
if area_index % 10 == 0:  # 可修改为 5, 15, 20 等
    clean_memory()
```

## 📦 依赖库

确保已安装以下库：
```bash
pip install psutil
```

## ⚠️ 注意事项

1. **Chrome浏览器内存**: 
   - 浏览器本身会占用额外内存（100-500MB）
   - 这是正常现象，由Playwright控制

2. **数据库连接**:
   - MongoDB连接保持活跃
   - 使用连接池管理，不会导致内存泄漏

3. **长时间运行**:
   - 建议定期查看内存报告
   - 如发现异常增长，可手动重启程序
   - 断点续传功能确保不会丢失进度

## 🎯 最佳实践

1. ✅ 使用批量插入而非逐条插入
2. ✅ 及时清空已处理的数据缓存
3. ✅ 定期触发垃圾回收
4. ✅ 监控内存使用趋势
5. ✅ 使用上下文管理器管理资源

## 📞 问题排查

### 内存持续增长？
1. 检查批次大小是否过大
2. 确认数据是否正确清空
3. 查看日志中的内存清理记录

### 如何查看详细内存信息？
查看日志文件中的所有 `🧹` 和 `📊` 标记的行

---

**最后更新**: 2025-11-17  
**版本**: 2.0 (内存优化版)
